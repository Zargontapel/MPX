<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>PMOS Programmers Manual: src/MPX_R5.C File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<h1>src/MPX_R5.C File Reference</h1>  </div>
</div>
<div class="contents">
<code>#include &quot;mpx_supt.h&quot;</code><br/>
<code>#include &lt;stdlib.h&gt;</code><br/>
<code>#include &lt;dos.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="_m_p_x___r5_8h_source.html">MPX_R5.h</a>&quot;</code><br/>

<p><a href="_m_p_x___r5_8_c_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_m_p_x___r5_8_c.html#a0f07dfc5a6bf6db22a31ba4f2e7d2f35">com_open</a> (int *eflag, int baudrate)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_m_p_x___r5_8_c.html#aa39f1d25e881ffac9559b2fe816fe943">com_close</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void interrupt&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_m_p_x___r5_8_c.html#a49235bff2654267b70d5656543f2ba81">level1</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_m_p_x___r5_8_c.html#a4e674e8641ca22513d0e38e17f9df632">level2Write</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_m_p_x___r5_8_c.html#aa1236f07727d3a0a5182b8594b043dad">level2Read</a> ()</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_m_p_x___r5_8_c.html#a5d2d449f4aadb74a2eb2b4aadeaf4b57">com_read</a> (char *buf_p, int *count_p)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="_m_p_x___r5_8_c.html#af03ea2dd941f2ecc4035da028d1f41b5">com_write</a> (char *buf_p, int *count_p)</td></tr>
</table>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="aa39f1d25e881ffac9559b2fe816fe943"></a><!-- doxytag: member="MPX_R5.C::com_close" ref="aa39f1d25e881ffac9559b2fe816fe943" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int com_close </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_m_p_x___r5_8_c_source.html#l00049">49</a> of file <a class="el" href="_m_p_x___r5_8_c_source.html">MPX_R5.C</a>.</p>

<p><div class="fragment"><pre class="fragment">                            {
                <span class="keywordtype">int</span> mask; 
        
                <span class="keywordflow">if</span>(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ac2d4a1d39c1a5a858d88f2482d6900c8">flag</a> != <a class="code" href="_m_p_x___r5_8h.html#a1354b70ac6803a06beebe84f61b5f95b">OPEN</a>) <span class="comment">//check that port is open</span>
                        <span class="keywordflow">return</span> SERIAL_PORT_NOT_OPEN; 
         
                <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ac2d4a1d39c1a5a858d88f2482d6900c8">flag</a>=CLOSED; 
                disable(); <span class="comment">//start enable </span>
                mask = inportb(<a class="code" href="_m_p_x___r5_8h.html#a89831dd7cb646bfa61461e0b1d91add7">PIC_MASK</a>); 
                mask = mask | 0x10; 
                outportb(<a class="code" href="_m_p_x___r5_8h.html#a89831dd7cb646bfa61461e0b1d91add7">PIC_MASK</a>, mask); 
                enable(); <span class="comment">//end enable </span>
         
                outportb( <a class="code" href="_m_p_x___r5_8h.html#ab9e061e05d689a5769936b213022102f">MS</a>,0x00); <span class="comment">// clears Modem Control Status</span>
                outportb( <a class="code" href="_m_p_x___r5_8h.html#a8dc8a6ba32861f0a3cbd89fa1ec0d216">INT_EN</a>,0x00); <span class="comment">// clears int_en</span>
                setvect( <a class="code" href="_m_p_x___r5_8h.html#a57912ff27e6b123b86821203a0338760">INT_ID</a>, <a class="code" href="_m_p_x___r5_8h.html#aecebfaddee878c55ece8a1aa8ac843d4">oldfunc</a>); <span class="comment">//restore Microsoft interupt </span>
         
                <span class="keywordflow">return</span> 0; 
        
        }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a0f07dfc5a6bf6db22a31ba4f2e7d2f35"></a><!-- doxytag: member="MPX_R5.C::com_open" ref="a0f07dfc5a6bf6db22a31ba4f2e7d2f35" args="(int *eflag, int baudrate)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int com_open </td>
          <td>(</td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>eflag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>baudrate</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_m_p_x___r5_8_c_source.html#l00006">6</a> of file <a class="el" href="_m_p_x___r5_8_c_source.html">MPX_R5.C</a>.</p>

<p><div class="fragment"><pre class="fragment">                                               {
                <span class="keywordtype">long</span> brd;
                <span class="keywordtype">int</span> mask;

                <span class="keywordflow">if</span>(eflag == NULL)
                        <span class="keywordflow">return</span> INV_FLAG; <span class="comment">// invalid flag</span>
                <span class="keywordflow">if</span>(baudrate &lt;= 0)
                        <span class="keywordflow">return</span> INV_BAUD;  <span class="comment">// invalid baud</span>
                <span class="keywordflow">if</span>(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ac2d4a1d39c1a5a858d88f2482d6900c8">flag</a>==<a class="code" href="_m_p_x___r5_8h.html#a1354b70ac6803a06beebe84f61b5f95b">OPEN</a>) <span class="comment">// Make sure that the device is not open.</span>
                        <span class="keywordflow">return</span> PORT_ALREADY_OPEN;

                <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ac2d4a1d39c1a5a858d88f2482d6900c8">flag</a> = OPEN;
                <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aa14e67b7bd4e2bc5751268f0be91983f">flag_ptr</a> = eflag;
                <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aaaefcdae0117d89bef5340a1e3f432e1">status</a> = IDLE; 
                <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a87b6f10cd47f45a38cfa264c298acc04">ringbufin</a> = 0; 
                <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ac5f863bd4d89e6182fb4c517d93afb8e">ringbufout</a> = 0; 
                <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ad06a8146a22a605c0f463b212774cc92">ringbufcount</a> = 0;
          
                <a class="code" href="_m_p_x___r5_8h.html#aecebfaddee878c55ece8a1aa8ac843d4">oldfunc</a> = getvect(<a class="code" href="_m_p_x___r5_8h.html#a57912ff27e6b123b86821203a0338760">INT_ID</a>); <span class="comment">//get the vector of the Windows comport interupt handler  </span>
                setvect(<a class="code" href="_m_p_x___r5_8h.html#a57912ff27e6b123b86821203a0338760">INT_ID</a>, &amp;<a class="code" href="_m_p_x___r5_8_c.html#a49235bff2654267b70d5656543f2ba81">level1</a>); <span class="comment">//level1 is interrupt handler      </span>
                brd = 115200 / (long) baudrate; <span class="comment">//calculate baud rate divisor</span>
         
                
                outportb(<a class="code" href="_m_p_x___r5_8h.html#aa499bb75bb504909cd0a72baf48c4653">LC</a>, 0x80); <span class="comment">//store 0x80 in line control register </span>
                outportb(<a class="code" href="_m_p_x___r5_8h.html#a4c32fec003a7f9e7fefc8b8b1f237dd8">BRD_LSB</a>, brd &amp; 0xFF); <span class="comment">//is Baud rate devisor LSB       </span>
                outportb(<a class="code" href="_m_p_x___r5_8h.html#aa071df7caa6499a431c734cc5adde587">BRD_MSB</a>,(brd&gt;&gt;8) &amp; 0xFF); <span class="comment">//is Baud rate devisor MSB   </span>
                outportb(<a class="code" href="_m_p_x___r5_8h.html#aa499bb75bb504909cd0a72baf48c4653">LC</a>, 0x03); <span class="comment">//store 0x03 in line control register </span>
        
                disable(); <span class="comment">// disable interupts </span>
                mask = inportb(<a class="code" href="_m_p_x___r5_8h.html#a89831dd7cb646bfa61461e0b1d91add7">PIC_MASK</a>); 
                mask = mask &amp; 0xEF; 
                outportb(<a class="code" href="_m_p_x___r5_8h.html#a89831dd7cb646bfa61461e0b1d91add7">PIC_MASK</a>, mask); 
                enable(); <span class="comment">// enable interupts</span>
         
                <span class="comment">//enable level for COM1 in PIC Mask register </span>
                <span class="comment">//Store 0x08 in modem control register </span>
                outportb( <a class="code" href="_m_p_x___r5_8h.html#a71d9e511e7e302cd831e83581219e70d">MC</a>, 0x08);<span class="comment">//enables serial interrupts </span>
                <span class="comment">//store 0x01 in interrupt enable register </span>
                outportb( <a class="code" href="_m_p_x___r5_8h.html#a8dc8a6ba32861f0a3cbd89fa1ec0d216">INT_EN</a>, 0x01);<span class="comment">//enables input ready interrupts </span>
         
    <span class="keywordflow">return</span> 0; <span class="comment">// return zero if no error.</span>
        }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a5d2d449f4aadb74a2eb2b4aadeaf4b57"></a><!-- doxytag: member="MPX_R5.C::com_read" ref="a5d2d449f4aadb74a2eb2b4aadeaf4b57" args="(char *buf_p, int *count_p)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int com_read </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>buf_p</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>count_p</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_m_p_x___r5_8_c_source.html#l00143">143</a> of file <a class="el" href="_m_p_x___r5_8_c_source.html">MPX_R5.C</a>.</p>

<p><div class="fragment"><pre class="fragment">                                               {
                <span class="comment">//Validate the supplied parameters. </span>
                <span class="keywordflow">if</span>(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ac2d4a1d39c1a5a858d88f2482d6900c8">flag</a> != <a class="code" href="_m_p_x___r5_8h.html#a1354b70ac6803a06beebe84f61b5f95b">OPEN</a>) <span class="comment">//check if device is open</span>
                        <span class="keywordflow">return</span> READ_PORT_NOT_OPEN;
                <span class="keywordflow">if</span>(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aaaefcdae0117d89bef5340a1e3f432e1">status</a> != <a class="code" href="_m_p_x___r5_8h.html#a9c21a7caee326d7803b94ae1952b27ca">IDLE</a>) <span class="comment">//check if device is idle</span>
                        <span class="keywordflow">return</span> READ_DEV_BUSY;
                <span class="keywordflow">if</span>( buf_p == NULL) <span class="comment">//check if buffer is empty </span>
                        <span class="keywordflow">return</span> READ_INV_BUFF_ADD; 
                <span class="keywordflow">if</span>( &amp;count_p == NULL) <span class="comment">//check if count pointer is null </span>
                        <span class="keywordflow">return</span> READ_INV_COUNT;  
        <span class="comment">// Initialize the input buffer variables (not the ring buffer!) and set the status to reading. </span>
                <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a031f8856932341c5b5bf979b4da0d5df">inbuff</a> = buf_p; 
                <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ab46085fdbca4da85dfbbbf7baafc4612">incount</a> = count_p; 
                <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aff338e9d555a8f740e997650a862b523">indone</a> = 0; 

                *(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aa14e67b7bd4e2bc5751268f0be91983f">flag_ptr</a>) = <a class="code" href="_m_p_x___r5_8h.html#a269d0ebbb16b030f6fe231046e7c084a">FLAG_CLEAR</a>; <span class="comment">//clear event flag</span>
                
                disable(); <span class="comment">//disable interrupts </span>
                <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aaaefcdae0117d89bef5340a1e3f432e1">status</a>=READ; <span class="comment">//we are now reading</span>

                <span class="comment">/* Copy characters from the ring buffer to the requestor&#39;s buffer, </span>
<span class="comment">                until the ring buffer is emptied, the requested count has been </span>
<span class="comment">                reached, or a CR (ENTER) code has been found. The copied </span>
<span class="comment">                characters should, of course, be removed from the ring buffer.</span>
<span class="comment">                Either input interrupts or all interrupts should be disabled </span>
<span class="comment">                during the copying. */</span> 

                <span class="keywordflow">while</span>((<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ad06a8146a22a605c0f463b212774cc92">ringbufcount</a> &gt;0) &amp;&amp; (<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a031f8856932341c5b5bf979b4da0d5df">inbuff</a>-1 !=<span class="charliteral">&#39;\r&#39;</span> &amp;&amp; (<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aff338e9d555a8f740e997650a862b523">indone</a> &gt;= *(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ab46085fdbca4da85dfbbbf7baafc4612">incount</a>)))){
                                *((<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a031f8856932341c5b5bf979b4da0d5df">inbuff</a>)) = <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#add9c4fe8b331128af0f655bc74410ffd">ringbuf</a>[<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ac5f863bd4d89e6182fb4c517d93afb8e">ringbufout</a>]; 
                                <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aff338e9d555a8f740e997650a862b523">indone</a>++; 
                                <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a031f8856932341c5b5bf979b4da0d5df">inbuff</a>++;
                                <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ac5f863bd4d89e6182fb4c517d93afb8e">ringbufout</a> = (<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ac5f863bd4d89e6182fb4c517d93afb8e">ringbufout</a>+1)%<a class="code" href="_m_p_x___r5_8h.html#aa23c661441688350614bd6a350d2b6ff">size</a>;
                                <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ad06a8146a22a605c0f463b212774cc92">ringbufcount</a>--;
                                
                        } <span class="comment">//end while </span>
          
                        enable(); <span class="comment">//enable interrupts </span>
        
                <span class="comment">//the requestor buffer is not yet full     </span>
                <span class="keywordflow">if</span>(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aff338e9d555a8f740e997650a862b523">indone</a> &lt; *(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ab46085fdbca4da85dfbbbf7baafc4612">incount</a>)) 
                        <span class="keywordflow">return</span> 0;  
                <span class="keywordflow">if</span>(*(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a031f8856932341c5b5bf979b4da0d5df">inbuff</a>-1) == <span class="charliteral">&#39;\r&#39;</span>)
                        *(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a031f8856932341c5b5bf979b4da0d5df">inbuff</a>-1) = <span class="charliteral">&#39;\0&#39;</span>;
                <span class="keywordflow">else</span>
                        *<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a031f8856932341c5b5bf979b4da0d5df">inbuff</a> = <span class="charliteral">&#39;\0&#39;</span>;
                
                <span class="comment">//Reset the DCB status to idle, set the event flag, and</span>
                <span class="comment">//return the actual count to the requestor&#39;s variable. </span>
                <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aaaefcdae0117d89bef5340a1e3f432e1">status</a> = IDLE; <span class="comment">//status back to IDLE </span>
                *<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aa14e67b7bd4e2bc5751268f0be91983f">flag_ptr</a> = SET; <span class="comment">//the event is over </span>
                *<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ab46085fdbca4da85dfbbbf7baafc4612">incount</a> = <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aff338e9d555a8f740e997650a862b523">indone</a>; 
         <span class="keywordflow">return</span> 0;
        }
</pre></div></p>

</div>
</div>
<a class="anchor" id="af03ea2dd941f2ecc4035da028d1f41b5"></a><!-- doxytag: member="MPX_R5.C::com_write" ref="af03ea2dd941f2ecc4035da028d1f41b5" args="(char *buf_p, int *count_p)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int com_write </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>buf_p</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>count_p</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_m_p_x___r5_8_c_source.html#l00197">197</a> of file <a class="el" href="_m_p_x___r5_8_c_source.html">MPX_R5.C</a>.</p>

<p><div class="fragment"><pre class="fragment">                                                {
                <span class="keywordtype">int</span> mask; 
                <span class="comment">//Ensure that the input parameters are valid. </span>
                <span class="keywordflow">if</span>(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ac2d4a1d39c1a5a858d88f2482d6900c8">flag</a> != <a class="code" href="_m_p_x___r5_8h.html#a1354b70ac6803a06beebe84f61b5f95b">OPEN</a>) <span class="comment">//check if device is open </span>
                        <span class="keywordflow">return</span> WRITE_PORT_NOT_OPEN; 
                <span class="keywordflow">if</span>(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aaaefcdae0117d89bef5340a1e3f432e1">status</a> != <a class="code" href="_m_p_x___r5_8h.html#a9c21a7caee326d7803b94ae1952b27ca">IDLE</a>) <span class="comment">//check if device is idle </span>
                        <span class="keywordflow">return</span> WRITE_DEV_BUSY; 
                <span class="keywordflow">if</span>(buf_p == NULL) <span class="comment">//check if buffer is empty </span>
                        <span class="keywordflow">return</span> WRITE_INV_BUFF_ADD; 
                <span class="keywordflow">if</span>(count_p == NULL) <span class="comment">//check pointer is null </span>
                        <span class="keywordflow">return</span> WRITE_INV_COUNT; 
                
                <span class="comment">//Install the buffer pointer and counters in the DCB, and set the current status to writing. </span>
                <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a32acea82810b51d93df2d3ced6cdffb7">outbuff</a> = buf_p; 
                <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ae597c46dee282a47174100b12525b424">outcount</a> = count_p; 
                <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ab7c43127bcb340d678131fd04c37ba05">outdone</a> = 0; 
                <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aaaefcdae0117d89bef5340a1e3f432e1">status</a> = WRITE;
                <span class="comment">//Clear the caller&#39;s event flag. </span>
                *<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aa14e67b7bd4e2bc5751268f0be91983f">flag_ptr</a> = FLAG_CLEAR; 
                
                <span class="comment">//Get the first character from the requestor&#39;s buffer and store it in the output register. </span>
                outportb(<a class="code" href="_m_p_x___r5_8h.html#a79bcfb6bde984f42d1124b068a509af7">BASE</a>, *<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a32acea82810b51d93df2d3ced6cdffb7">outbuff</a>); 
                <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a32acea82810b51d93df2d3ced6cdffb7">outbuff</a>++; 
                <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ab7c43127bcb340d678131fd04c37ba05">outdone</a>++; 
         
                 
                 <span class="comment">//Enable write interrupts by setting bit 1 of the Interrupt Enable register. </span>
                 <span class="comment">//This must be done by setting the register to the logical or of its previous </span>
                 <span class="comment">//contents and 0x02. </span>

                mask = inportb(<a class="code" href="_m_p_x___r5_8h.html#a8dc8a6ba32861f0a3cbd89fa1ec0d216">INT_EN</a>); 
                mask = mask | 0x02; 
                outportb(<a class="code" href="_m_p_x___r5_8h.html#a8dc8a6ba32861f0a3cbd89fa1ec0d216">INT_EN</a>,mask); 
    
        <span class="keywordflow">return</span> 0; 
        }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a49235bff2654267b70d5656543f2ba81"></a><!-- doxytag: member="MPX_R5.C::level1" ref="a49235bff2654267b70d5656543f2ba81" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void interrupt level1 </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_m_p_x___r5_8_c_source.html#l00070">70</a> of file <a class="el" href="_m_p_x___r5_8_c_source.html">MPX_R5.C</a>.</p>

<p><div class="fragment"><pre class="fragment">                               {
                <span class="keywordflow">if</span>(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ac2d4a1d39c1a5a858d88f2482d6900c8">flag</a> != <a class="code" href="_m_p_x___r5_8h.html#a1354b70ac6803a06beebe84f61b5f95b">OPEN</a>){ 
                        outportb(<a class="code" href="_m_p_x___r5_8h.html#a5a66cf9d58dff90a490d82a1dbd56968">PIC_CMD</a>, <a class="code" href="_m_p_x___r5_8h.html#a04c9015da7e7ea45f3b80793809e2d7b">EOI</a>);<span class="comment">//clear interupt PIC command register </span>
                        <span class="keywordflow">return</span>; 
                } <span class="keywordflow">else</span>{ 
                        <a class="code" href="_m_p_x___r5_8h.html#a86cf672daa4e0ad11ad10efc894d19c8">num</a> = ((inportb(<a class="code" href="_m_p_x___r5_8h.html#a2d1977759194644a0f9d516c4aed28d5">INT_ID_REG</a>) &amp; WHATINTERRUPTBIT));
                        <span class="keywordflow">if</span> (<a class="code" href="_m_p_x___r5_8h.html#a86cf672daa4e0ad11ad10efc894d19c8">num</a> == 2) <span class="comment">// 0000 0010 : write interrupt </span>
                                <a class="code" href="_m_p_x___r5_8_c.html#a4e674e8641ca22513d0e38e17f9df632">level2Write</a>(); 
                        <span class="keywordflow">if</span> (<a class="code" href="_m_p_x___r5_8h.html#a86cf672daa4e0ad11ad10efc894d19c8">num</a> == 4) <span class="comment">// 0000 0100 : read interrupt </span>
                                <a class="code" href="_m_p_x___r5_8_c.html#aa1236f07727d3a0a5182b8594b043dad">level2Read</a>();     
                        outportb(<a class="code" href="_m_p_x___r5_8h.html#a5a66cf9d58dff90a490d82a1dbd56968">PIC_CMD</a>, <a class="code" href="_m_p_x___r5_8h.html#a04c9015da7e7ea45f3b80793809e2d7b">EOI</a>); <span class="comment">//clear interupt PIC command register </span>
                } 
    <span class="keywordflow">return</span>; 

        }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa1236f07727d3a0a5182b8594b043dad"></a><!-- doxytag: member="MPX_R5.C::level2Read" ref="aa1236f07727d3a0a5182b8594b043dad" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void level2Read </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_m_p_x___r5_8_c_source.html#l00110">110</a> of file <a class="el" href="_m_p_x___r5_8_c_source.html">MPX_R5.C</a>.</p>

<p><div class="fragment"><pre class="fragment">                         {
                <span class="keywordtype">char</span> <span class="keyword">new</span>;
                <span class="keywordtype">char</span> ret = <span class="charliteral">&#39;\r&#39;</span>;
                
                <span class="keyword">new</span>=inportb(<a class="code" href="_m_p_x___r5_8h.html#a79bcfb6bde984f42d1124b068a509af7">BASE</a>); <span class="comment">//Read a character from the input register. </span>
                <span class="keywordflow">if</span> ( <span class="keyword">new</span> != ret )
                outportb(<a class="code" href="_m_p_x___r5_8h.html#a79bcfb6bde984f42d1124b068a509af7">BASE</a>, <span class="keyword">new</span>);<span class="comment">// ECHO BACK</span>
                <span class="comment">//If the current status is not reading, store the character in the ring buffer. </span>
                <span class="keywordflow">if</span>(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aaaefcdae0117d89bef5340a1e3f432e1">status</a> != <a class="code" href="_m_p_x___r5_8h.html#ada74e7db007a68e763f20c17f2985356">READ</a>){
                        <span class="keywordflow">if</span>(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ad06a8146a22a605c0f463b212774cc92">ringbufcount</a> != <a class="code" href="_m_p_x___r5_8h.html#aa23c661441688350614bd6a350d2b6ff">size</a>){
                                <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#add9c4fe8b331128af0f655bc74410ffd">ringbuf</a>[<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a87b6f10cd47f45a38cfa264c298acc04">ringbufin</a>]= <span class="keyword">new</span>;
                                <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a87b6f10cd47f45a38cfa264c298acc04">ringbufin</a> = (<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a87b6f10cd47f45a38cfa264c298acc04">ringbufin</a>+1)%<a class="code" href="_m_p_x___r5_8h.html#aa23c661441688350614bd6a350d2b6ff">size</a>;
                                <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ad06a8146a22a605c0f463b212774cc92">ringbufcount</a>++;
                        }
                }<span class="keywordflow">else</span>{ <span class="comment">//status is reading</span>
                        *<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a031f8856932341c5b5bf979b4da0d5df">inbuff</a> = <span class="keyword">new</span>;
                        <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a031f8856932341c5b5bf979b4da0d5df">inbuff</a>++;
                        <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aff338e9d555a8f740e997650a862b523">indone</a>++;
                                <span class="comment">//If the count is not completed and the character is not CR, return. Do not signal completion. </span>
                        <span class="keywordflow">if</span>(<span class="keyword">new</span>== <span class="charliteral">&#39;\r&#39;</span> || (<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aff338e9d555a8f740e997650a862b523">indone</a> ) &gt;= *(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ab46085fdbca4da85dfbbbf7baafc4612">incount</a>)){
                                <span class="keywordflow">if</span>(*(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a031f8856932341c5b5bf979b4da0d5df">inbuff</a>-1) == <span class="charliteral">&#39;\r&#39;</span>){
                                        *(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a031f8856932341c5b5bf979b4da0d5df">inbuff</a>-1) = <span class="charliteral">&#39;\0&#39;</span>;
                                }<span class="keywordflow">else</span>{
                                        *<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a031f8856932341c5b5bf979b4da0d5df">inbuff</a> = <span class="charliteral">&#39;\0&#39;</span>;
                                }
                                *<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ab46085fdbca4da85dfbbbf7baafc4612">incount</a> = <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aff338e9d555a8f740e997650a862b523">indone</a>;
                                <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aaaefcdae0117d89bef5340a1e3f432e1">status</a> =IDLE;
                                *<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aa14e67b7bd4e2bc5751268f0be91983f">flag_ptr</a> = SET;
                }<span class="comment">//end if</span>
        }<span class="comment">//end else</span>

        }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a4e674e8641ca22513d0e38e17f9df632"></a><!-- doxytag: member="MPX_R5.C::level2Write" ref="a4e674e8641ca22513d0e38e17f9df632" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void level2Write </td>
          <td>(</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="_m_p_x___r5_8_c_source.html#l00086">86</a> of file <a class="el" href="_m_p_x___r5_8_c_source.html">MPX_R5.C</a>.</p>

<p><div class="fragment"><pre class="fragment">                          {

                <span class="keywordtype">int</span> mask; 
         
                <span class="keywordflow">if</span>(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>. <a class="code" href="trmdrive_8c.html#a6e27f49150e9a14580fb313cc2777e00">status</a> != <a class="code" href="_m_p_x___r5_8h.html#aa10f470e996d0f51210d24f442d25e1e">WRITE</a>) 
                        <span class="keywordflow">return</span>; <span class="comment">//Ignore the interrupt and return</span>

                <span class="keywordflow">if</span>(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ab7c43127bcb340d678131fd04c37ba05">outdone</a> &lt; *<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ae597c46dee282a47174100b12525b424">outcount</a>){
                        outportb(<a class="code" href="_m_p_x___r5_8h.html#a79bcfb6bde984f42d1124b068a509af7">BASE</a>, *<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a32acea82810b51d93df2d3ced6cdffb7">outbuff</a>);
                        <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a32acea82810b51d93df2d3ced6cdffb7">outbuff</a>++; 
                        <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ab7c43127bcb340d678131fd04c37ba05">outdone</a>++;
                        <span class="keywordflow">return</span>;
                }<span class="keywordflow">else</span>{

                        <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aaaefcdae0117d89bef5340a1e3f432e1">status</a> = IDLE;
                        *<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aa14e67b7bd4e2bc5751268f0be91983f">flag_ptr</a> = SET;

                        mask = inportb(<a class="code" href="_m_p_x___r5_8h.html#a8dc8a6ba32861f0a3cbd89fa1ec0d216">INT_EN</a>);
                        mask = mask&amp;~0x02;
                        outportb(<a class="code" href="_m_p_x___r5_8h.html#a8dc8a6ba32861f0a3cbd89fa1ec0d216">INT_EN</a>, mask);
                        <span class="keywordflow">return</span>;
                }
        }
</pre></div></p>

</div>
</div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Fri Dec 10 2010 01:08:39 for PMOS Programmers Manual by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
