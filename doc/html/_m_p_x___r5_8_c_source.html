<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>PMOS Programmers Manual: src/MPX_R5.C Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<h1>src/MPX_R5.C</h1>  </div>
</div>
<div class="contents">
<a href="_m_p_x___r5_8_c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="preprocessor"># include &quot;mpx_supt.h&quot;</span>
<a name="l00002"></a>00002 <span class="preprocessor"># include &lt;stdlib.h&gt;</span> 
<a name="l00003"></a>00003 <span class="preprocessor"># include &lt;dos.h&gt;</span> 
<a name="l00004"></a>00004 <span class="preprocessor"># include &quot;<a class="code" href="_m_p_x___r5_8h.html">MPX_R5.h</a>&quot;</span>
<a name="l00005"></a>00005 
<a name="l00006"></a><a class="code" href="_m_p_x___r5_8h.html#a4a6717eaeef77abf4f0604a3c91e26be">00006</a>         <span class="keywordtype">int</span> <a class="code" href="_m_p_x___r5_8_c.html#a0f07dfc5a6bf6db22a31ba4f2e7d2f35">com_open</a> (<span class="keywordtype">int</span> *eflag, <span class="keywordtype">int</span> baudrate){
<a name="l00007"></a>00007                 <span class="keywordtype">long</span> brd;
<a name="l00008"></a>00008                 <span class="keywordtype">int</span> mask;
<a name="l00009"></a>00009 
<a name="l00010"></a>00010                 <span class="keywordflow">if</span>(eflag == NULL)
<a name="l00011"></a>00011                         <span class="keywordflow">return</span> INV_FLAG; <span class="comment">// invalid flag</span>
<a name="l00012"></a>00012                 <span class="keywordflow">if</span>(baudrate &lt;= 0)
<a name="l00013"></a>00013                         <span class="keywordflow">return</span> INV_BAUD;  <span class="comment">// invalid baud</span>
<a name="l00014"></a>00014                 <span class="keywordflow">if</span>(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ac2d4a1d39c1a5a858d88f2482d6900c8">flag</a>==<a class="code" href="_m_p_x___r5_8h.html#a1354b70ac6803a06beebe84f61b5f95b">OPEN</a>) <span class="comment">// Make sure that the device is not open.</span>
<a name="l00015"></a>00015                         <span class="keywordflow">return</span> PORT_ALREADY_OPEN;
<a name="l00016"></a>00016 
<a name="l00017"></a>00017                 <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ac2d4a1d39c1a5a858d88f2482d6900c8">flag</a> = OPEN;
<a name="l00018"></a>00018                 <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aa14e67b7bd4e2bc5751268f0be91983f">flag_ptr</a> = eflag;
<a name="l00019"></a>00019                 <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aaaefcdae0117d89bef5340a1e3f432e1">status</a> = IDLE; 
<a name="l00020"></a>00020                 <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a87b6f10cd47f45a38cfa264c298acc04">ringbufin</a> = 0; 
<a name="l00021"></a>00021                 <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ac5f863bd4d89e6182fb4c517d93afb8e">ringbufout</a> = 0; 
<a name="l00022"></a>00022                 <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ad06a8146a22a605c0f463b212774cc92">ringbufcount</a> = 0;
<a name="l00023"></a>00023           
<a name="l00024"></a>00024                 <a class="code" href="_m_p_x___r5_8h.html#aecebfaddee878c55ece8a1aa8ac843d4">oldfunc</a> = getvect(<a class="code" href="_m_p_x___r5_8h.html#a57912ff27e6b123b86821203a0338760">INT_ID</a>); <span class="comment">//get the vector of the Windows comport interupt handler  </span>
<a name="l00025"></a>00025                 setvect(<a class="code" href="_m_p_x___r5_8h.html#a57912ff27e6b123b86821203a0338760">INT_ID</a>, &amp;<a class="code" href="_m_p_x___r5_8_c.html#a49235bff2654267b70d5656543f2ba81">level1</a>); <span class="comment">//level1 is interrupt handler      </span>
<a name="l00026"></a>00026                 brd = 115200 / (long) baudrate; <span class="comment">//calculate baud rate divisor</span>
<a name="l00027"></a>00027          
<a name="l00028"></a>00028                 
<a name="l00029"></a>00029                 outportb(<a class="code" href="_m_p_x___r5_8h.html#aa499bb75bb504909cd0a72baf48c4653">LC</a>, 0x80); <span class="comment">//store 0x80 in line control register </span>
<a name="l00030"></a>00030                 outportb(<a class="code" href="_m_p_x___r5_8h.html#a4c32fec003a7f9e7fefc8b8b1f237dd8">BRD_LSB</a>, brd &amp; 0xFF); <span class="comment">//is Baud rate devisor LSB       </span>
<a name="l00031"></a>00031                 outportb(<a class="code" href="_m_p_x___r5_8h.html#aa071df7caa6499a431c734cc5adde587">BRD_MSB</a>,(brd&gt;&gt;8) &amp; 0xFF); <span class="comment">//is Baud rate devisor MSB   </span>
<a name="l00032"></a>00032                 outportb(<a class="code" href="_m_p_x___r5_8h.html#aa499bb75bb504909cd0a72baf48c4653">LC</a>, 0x03); <span class="comment">//store 0x03 in line control register </span>
<a name="l00033"></a>00033         
<a name="l00034"></a>00034                 disable(); <span class="comment">// disable interupts </span>
<a name="l00035"></a>00035                 mask = inportb(<a class="code" href="_m_p_x___r5_8h.html#a89831dd7cb646bfa61461e0b1d91add7">PIC_MASK</a>); 
<a name="l00036"></a>00036                 mask = mask &amp; 0xEF; 
<a name="l00037"></a>00037                 outportb(<a class="code" href="_m_p_x___r5_8h.html#a89831dd7cb646bfa61461e0b1d91add7">PIC_MASK</a>, mask); 
<a name="l00038"></a>00038                 enable(); <span class="comment">// enable interupts</span>
<a name="l00039"></a>00039          
<a name="l00040"></a>00040                 <span class="comment">//enable level for COM1 in PIC Mask register </span>
<a name="l00041"></a>00041                 <span class="comment">//Store 0x08 in modem control register </span>
<a name="l00042"></a>00042                 outportb( <a class="code" href="_m_p_x___r5_8h.html#a71d9e511e7e302cd831e83581219e70d">MC</a>, 0x08);<span class="comment">//enables serial interrupts </span>
<a name="l00043"></a>00043                 <span class="comment">//store 0x01 in interrupt enable register </span>
<a name="l00044"></a>00044                 outportb( <a class="code" href="_m_p_x___r5_8h.html#a8dc8a6ba32861f0a3cbd89fa1ec0d216">INT_EN</a>, 0x01);<span class="comment">//enables input ready interrupts </span>
<a name="l00045"></a>00045          
<a name="l00046"></a>00046     <span class="keywordflow">return</span> 0; <span class="comment">// return zero if no error.</span>
<a name="l00047"></a>00047         }
<a name="l00048"></a>00048         
<a name="l00049"></a><a class="code" href="_m_p_x___r5_8h.html#aa39f1d25e881ffac9559b2fe816fe943">00049</a>         <span class="keywordtype">int</span> <a class="code" href="_m_p_x___r5_8_c.html#aa39f1d25e881ffac9559b2fe816fe943">com_close</a> (<span class="keywordtype">void</span>){
<a name="l00050"></a>00050                 <span class="keywordtype">int</span> mask; 
<a name="l00051"></a>00051         
<a name="l00052"></a>00052                 <span class="keywordflow">if</span>(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ac2d4a1d39c1a5a858d88f2482d6900c8">flag</a> != <a class="code" href="_m_p_x___r5_8h.html#a1354b70ac6803a06beebe84f61b5f95b">OPEN</a>) <span class="comment">//check that port is open</span>
<a name="l00053"></a>00053                         <span class="keywordflow">return</span> SERIAL_PORT_NOT_OPEN; 
<a name="l00054"></a>00054          
<a name="l00055"></a>00055                 <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ac2d4a1d39c1a5a858d88f2482d6900c8">flag</a>=CLOSED; 
<a name="l00056"></a>00056                 disable(); <span class="comment">//start enable </span>
<a name="l00057"></a>00057                 mask = inportb(<a class="code" href="_m_p_x___r5_8h.html#a89831dd7cb646bfa61461e0b1d91add7">PIC_MASK</a>); 
<a name="l00058"></a>00058                 mask = mask | 0x10; 
<a name="l00059"></a>00059                 outportb(<a class="code" href="_m_p_x___r5_8h.html#a89831dd7cb646bfa61461e0b1d91add7">PIC_MASK</a>, mask); 
<a name="l00060"></a>00060                 enable(); <span class="comment">//end enable </span>
<a name="l00061"></a>00061          
<a name="l00062"></a>00062                 outportb( <a class="code" href="_m_p_x___r5_8h.html#ab9e061e05d689a5769936b213022102f">MS</a>,0x00); <span class="comment">// clears Modem Control Status</span>
<a name="l00063"></a>00063                 outportb( <a class="code" href="_m_p_x___r5_8h.html#a8dc8a6ba32861f0a3cbd89fa1ec0d216">INT_EN</a>,0x00); <span class="comment">// clears int_en</span>
<a name="l00064"></a>00064                 setvect( <a class="code" href="_m_p_x___r5_8h.html#a57912ff27e6b123b86821203a0338760">INT_ID</a>, <a class="code" href="_m_p_x___r5_8h.html#aecebfaddee878c55ece8a1aa8ac843d4">oldfunc</a>); <span class="comment">//restore Microsoft interupt </span>
<a name="l00065"></a>00065          
<a name="l00066"></a>00066                 <span class="keywordflow">return</span> 0; 
<a name="l00067"></a>00067         
<a name="l00068"></a>00068         }
<a name="l00069"></a>00069         
<a name="l00070"></a><a class="code" href="_m_p_x___r5_8h.html#a49235bff2654267b70d5656543f2ba81">00070</a>         <span class="keywordtype">void</span> interrupt <a class="code" href="_m_p_x___r5_8_c.html#a49235bff2654267b70d5656543f2ba81">level1</a>(){
<a name="l00071"></a>00071                 <span class="keywordflow">if</span>(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ac2d4a1d39c1a5a858d88f2482d6900c8">flag</a> != <a class="code" href="_m_p_x___r5_8h.html#a1354b70ac6803a06beebe84f61b5f95b">OPEN</a>){ 
<a name="l00072"></a>00072                         outportb(<a class="code" href="_m_p_x___r5_8h.html#a5a66cf9d58dff90a490d82a1dbd56968">PIC_CMD</a>, <a class="code" href="_m_p_x___r5_8h.html#a04c9015da7e7ea45f3b80793809e2d7b">EOI</a>);<span class="comment">//clear interupt PIC command register </span>
<a name="l00073"></a>00073                         <span class="keywordflow">return</span>; 
<a name="l00074"></a>00074                 } <span class="keywordflow">else</span>{ 
<a name="l00075"></a>00075                         <a class="code" href="_m_p_x___r5_8h.html#a86cf672daa4e0ad11ad10efc894d19c8">num</a> = ((inportb(<a class="code" href="_m_p_x___r5_8h.html#a2d1977759194644a0f9d516c4aed28d5">INT_ID_REG</a>) &amp; WHATINTERRUPTBIT));
<a name="l00076"></a>00076                         <span class="keywordflow">if</span> (<a class="code" href="_m_p_x___r5_8h.html#a86cf672daa4e0ad11ad10efc894d19c8">num</a> == 2) <span class="comment">// 0000 0010 : write interrupt </span>
<a name="l00077"></a>00077                                 <a class="code" href="_m_p_x___r5_8_c.html#a4e674e8641ca22513d0e38e17f9df632">level2Write</a>(); 
<a name="l00078"></a>00078                         <span class="keywordflow">if</span> (<a class="code" href="_m_p_x___r5_8h.html#a86cf672daa4e0ad11ad10efc894d19c8">num</a> == 4) <span class="comment">// 0000 0100 : read interrupt </span>
<a name="l00079"></a>00079                                 <a class="code" href="_m_p_x___r5_8_c.html#aa1236f07727d3a0a5182b8594b043dad">level2Read</a>();     
<a name="l00080"></a>00080                         outportb(<a class="code" href="_m_p_x___r5_8h.html#a5a66cf9d58dff90a490d82a1dbd56968">PIC_CMD</a>, <a class="code" href="_m_p_x___r5_8h.html#a04c9015da7e7ea45f3b80793809e2d7b">EOI</a>); <span class="comment">//clear interupt PIC command register </span>
<a name="l00081"></a>00081                 } 
<a name="l00082"></a>00082     <span class="keywordflow">return</span>; 
<a name="l00083"></a>00083 
<a name="l00084"></a>00084         }
<a name="l00085"></a>00085         
<a name="l00086"></a><a class="code" href="_m_p_x___r5_8h.html#a4e674e8641ca22513d0e38e17f9df632">00086</a>         <span class="keywordtype">void</span> <a class="code" href="_m_p_x___r5_8_c.html#a4e674e8641ca22513d0e38e17f9df632">level2Write</a>(){
<a name="l00087"></a>00087 
<a name="l00088"></a>00088                 <span class="keywordtype">int</span> mask; 
<a name="l00089"></a>00089          
<a name="l00090"></a>00090                 <span class="keywordflow">if</span>(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>. <a class="code" href="trmdrive_8c.html#a6e27f49150e9a14580fb313cc2777e00">status</a> != <a class="code" href="_m_p_x___r5_8h.html#aa10f470e996d0f51210d24f442d25e1e">WRITE</a>) 
<a name="l00091"></a>00091                         <span class="keywordflow">return</span>; <span class="comment">//Ignore the interrupt and return</span>
<a name="l00092"></a>00092 
<a name="l00093"></a>00093                 <span class="keywordflow">if</span>(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ab7c43127bcb340d678131fd04c37ba05">outdone</a> &lt; *<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ae597c46dee282a47174100b12525b424">outcount</a>){
<a name="l00094"></a>00094                         outportb(<a class="code" href="_m_p_x___r5_8h.html#a79bcfb6bde984f42d1124b068a509af7">BASE</a>, *<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a32acea82810b51d93df2d3ced6cdffb7">outbuff</a>);
<a name="l00095"></a>00095                         <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a32acea82810b51d93df2d3ced6cdffb7">outbuff</a>++; 
<a name="l00096"></a>00096                         <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ab7c43127bcb340d678131fd04c37ba05">outdone</a>++;
<a name="l00097"></a>00097                         <span class="keywordflow">return</span>;
<a name="l00098"></a>00098                 }<span class="keywordflow">else</span>{
<a name="l00099"></a>00099 
<a name="l00100"></a>00100                         <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aaaefcdae0117d89bef5340a1e3f432e1">status</a> = IDLE;
<a name="l00101"></a>00101                         *<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aa14e67b7bd4e2bc5751268f0be91983f">flag_ptr</a> = SET;
<a name="l00102"></a>00102 
<a name="l00103"></a>00103                         mask = inportb(<a class="code" href="_m_p_x___r5_8h.html#a8dc8a6ba32861f0a3cbd89fa1ec0d216">INT_EN</a>);
<a name="l00104"></a>00104                         mask = mask&amp;~0x02;
<a name="l00105"></a>00105                         outportb(<a class="code" href="_m_p_x___r5_8h.html#a8dc8a6ba32861f0a3cbd89fa1ec0d216">INT_EN</a>, mask);
<a name="l00106"></a>00106                         <span class="keywordflow">return</span>;
<a name="l00107"></a>00107                 }
<a name="l00108"></a>00108         }
<a name="l00109"></a>00109 
<a name="l00110"></a><a class="code" href="_m_p_x___r5_8h.html#aa1236f07727d3a0a5182b8594b043dad">00110</a>         <span class="keywordtype">void</span> <a class="code" href="_m_p_x___r5_8_c.html#aa1236f07727d3a0a5182b8594b043dad">level2Read</a>(){
<a name="l00111"></a>00111                 <span class="keywordtype">char</span> <span class="keyword">new</span>;
<a name="l00112"></a>00112                 <span class="keywordtype">char</span> ret = <span class="charliteral">&#39;\r&#39;</span>;
<a name="l00113"></a>00113                 
<a name="l00114"></a>00114                 <span class="keyword">new</span>=inportb(<a class="code" href="_m_p_x___r5_8h.html#a79bcfb6bde984f42d1124b068a509af7">BASE</a>); <span class="comment">//Read a character from the input register. </span>
<a name="l00115"></a>00115                 <span class="keywordflow">if</span> ( <span class="keyword">new</span> != ret )
<a name="l00116"></a>00116                 outportb(<a class="code" href="_m_p_x___r5_8h.html#a79bcfb6bde984f42d1124b068a509af7">BASE</a>, <span class="keyword">new</span>);<span class="comment">// ECHO BACK</span>
<a name="l00117"></a>00117                 <span class="comment">//If the current status is not reading, store the character in the ring buffer. </span>
<a name="l00118"></a>00118                 <span class="keywordflow">if</span>(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aaaefcdae0117d89bef5340a1e3f432e1">status</a> != <a class="code" href="_m_p_x___r5_8h.html#ada74e7db007a68e763f20c17f2985356">READ</a>){
<a name="l00119"></a>00119                         <span class="keywordflow">if</span>(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ad06a8146a22a605c0f463b212774cc92">ringbufcount</a> != <a class="code" href="_m_p_x___r5_8h.html#aa23c661441688350614bd6a350d2b6ff">size</a>){
<a name="l00120"></a>00120                                 <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#add9c4fe8b331128af0f655bc74410ffd">ringbuf</a>[<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a87b6f10cd47f45a38cfa264c298acc04">ringbufin</a>]= <span class="keyword">new</span>;
<a name="l00121"></a>00121                                 <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a87b6f10cd47f45a38cfa264c298acc04">ringbufin</a> = (<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a87b6f10cd47f45a38cfa264c298acc04">ringbufin</a>+1)%<a class="code" href="_m_p_x___r5_8h.html#aa23c661441688350614bd6a350d2b6ff">size</a>;
<a name="l00122"></a>00122                                 <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ad06a8146a22a605c0f463b212774cc92">ringbufcount</a>++;
<a name="l00123"></a>00123                         }
<a name="l00124"></a>00124                 }<span class="keywordflow">else</span>{ <span class="comment">//status is reading</span>
<a name="l00125"></a>00125                         *<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a031f8856932341c5b5bf979b4da0d5df">inbuff</a> = <span class="keyword">new</span>;
<a name="l00126"></a>00126                         <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a031f8856932341c5b5bf979b4da0d5df">inbuff</a>++;
<a name="l00127"></a>00127                         <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aff338e9d555a8f740e997650a862b523">indone</a>++;
<a name="l00128"></a>00128                                 <span class="comment">//If the count is not completed and the character is not CR, return. Do not signal completion. </span>
<a name="l00129"></a>00129                         <span class="keywordflow">if</span>(<span class="keyword">new</span>== <span class="charliteral">&#39;\r&#39;</span> || (<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aff338e9d555a8f740e997650a862b523">indone</a> ) &gt;= *(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ab46085fdbca4da85dfbbbf7baafc4612">incount</a>)){
<a name="l00130"></a>00130                                 <span class="keywordflow">if</span>(*(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a031f8856932341c5b5bf979b4da0d5df">inbuff</a>-1) == <span class="charliteral">&#39;\r&#39;</span>){
<a name="l00131"></a>00131                                         *(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a031f8856932341c5b5bf979b4da0d5df">inbuff</a>-1) = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00132"></a>00132                                 }<span class="keywordflow">else</span>{
<a name="l00133"></a>00133                                         *<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a031f8856932341c5b5bf979b4da0d5df">inbuff</a> = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00134"></a>00134                                 }
<a name="l00135"></a>00135                                 *<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ab46085fdbca4da85dfbbbf7baafc4612">incount</a> = <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aff338e9d555a8f740e997650a862b523">indone</a>;
<a name="l00136"></a>00136                                 <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aaaefcdae0117d89bef5340a1e3f432e1">status</a> =IDLE;
<a name="l00137"></a>00137                                 *<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aa14e67b7bd4e2bc5751268f0be91983f">flag_ptr</a> = SET;
<a name="l00138"></a>00138                 }<span class="comment">//end if</span>
<a name="l00139"></a>00139         }<span class="comment">//end else</span>
<a name="l00140"></a>00140 
<a name="l00141"></a>00141         }
<a name="l00142"></a>00142 
<a name="l00143"></a><a class="code" href="_m_p_x___r5_8h.html#aa7371bdaf13daffa9cb2abeec22755de">00143</a>         <span class="keywordtype">int</span> <a class="code" href="_m_p_x___r5_8_c.html#a5d2d449f4aadb74a2eb2b4aadeaf4b57">com_read</a> (<span class="keywordtype">char</span> *buf_p,<span class="keywordtype">int</span> *count_p){
<a name="l00144"></a>00144                 <span class="comment">//Validate the supplied parameters. </span>
<a name="l00145"></a>00145                 <span class="keywordflow">if</span>(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ac2d4a1d39c1a5a858d88f2482d6900c8">flag</a> != <a class="code" href="_m_p_x___r5_8h.html#a1354b70ac6803a06beebe84f61b5f95b">OPEN</a>) <span class="comment">//check if device is open</span>
<a name="l00146"></a>00146                         <span class="keywordflow">return</span> READ_PORT_NOT_OPEN;
<a name="l00147"></a>00147                 <span class="keywordflow">if</span>(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aaaefcdae0117d89bef5340a1e3f432e1">status</a> != <a class="code" href="_m_p_x___r5_8h.html#a9c21a7caee326d7803b94ae1952b27ca">IDLE</a>) <span class="comment">//check if device is idle</span>
<a name="l00148"></a>00148                         <span class="keywordflow">return</span> READ_DEV_BUSY;
<a name="l00149"></a>00149                 <span class="keywordflow">if</span>( buf_p == NULL) <span class="comment">//check if buffer is empty </span>
<a name="l00150"></a>00150                         <span class="keywordflow">return</span> READ_INV_BUFF_ADD; 
<a name="l00151"></a>00151                 <span class="keywordflow">if</span>( &amp;count_p == NULL) <span class="comment">//check if count pointer is null </span>
<a name="l00152"></a>00152                         <span class="keywordflow">return</span> READ_INV_COUNT;  
<a name="l00153"></a>00153         <span class="comment">// Initialize the input buffer variables (not the ring buffer!) and set the status to reading. </span>
<a name="l00154"></a>00154                 <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a031f8856932341c5b5bf979b4da0d5df">inbuff</a> = buf_p; 
<a name="l00155"></a>00155                 <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ab46085fdbca4da85dfbbbf7baafc4612">incount</a> = count_p; 
<a name="l00156"></a>00156                 <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aff338e9d555a8f740e997650a862b523">indone</a> = 0; 
<a name="l00157"></a>00157 
<a name="l00158"></a>00158                 *(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aa14e67b7bd4e2bc5751268f0be91983f">flag_ptr</a>) = <a class="code" href="_m_p_x___r5_8h.html#a269d0ebbb16b030f6fe231046e7c084a">FLAG_CLEAR</a>; <span class="comment">//clear event flag</span>
<a name="l00159"></a>00159                 
<a name="l00160"></a>00160                 disable(); <span class="comment">//disable interrupts </span>
<a name="l00161"></a>00161                 <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aaaefcdae0117d89bef5340a1e3f432e1">status</a>=READ; <span class="comment">//we are now reading</span>
<a name="l00162"></a>00162 
<a name="l00163"></a>00163                 <span class="comment">/* Copy characters from the ring buffer to the requestor&#39;s buffer, </span>
<a name="l00164"></a>00164 <span class="comment">                until the ring buffer is emptied, the requested count has been </span>
<a name="l00165"></a>00165 <span class="comment">                reached, or a CR (ENTER) code has been found. The copied </span>
<a name="l00166"></a>00166 <span class="comment">                characters should, of course, be removed from the ring buffer.</span>
<a name="l00167"></a>00167 <span class="comment">                Either input interrupts or all interrupts should be disabled </span>
<a name="l00168"></a>00168 <span class="comment">                during the copying. */</span> 
<a name="l00169"></a>00169 
<a name="l00170"></a>00170                 <span class="keywordflow">while</span>((<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ad06a8146a22a605c0f463b212774cc92">ringbufcount</a> &gt;0) &amp;&amp; (<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a031f8856932341c5b5bf979b4da0d5df">inbuff</a>-1 !=<span class="charliteral">&#39;\r&#39;</span> &amp;&amp; (<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aff338e9d555a8f740e997650a862b523">indone</a> &gt;= *(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ab46085fdbca4da85dfbbbf7baafc4612">incount</a>)))){
<a name="l00171"></a>00171                                 *((<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a031f8856932341c5b5bf979b4da0d5df">inbuff</a>)) = <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#add9c4fe8b331128af0f655bc74410ffd">ringbuf</a>[<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ac5f863bd4d89e6182fb4c517d93afb8e">ringbufout</a>]; 
<a name="l00172"></a>00172                                 <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aff338e9d555a8f740e997650a862b523">indone</a>++; 
<a name="l00173"></a>00173                                 <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a031f8856932341c5b5bf979b4da0d5df">inbuff</a>++;
<a name="l00174"></a>00174                                 <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ac5f863bd4d89e6182fb4c517d93afb8e">ringbufout</a> = (<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ac5f863bd4d89e6182fb4c517d93afb8e">ringbufout</a>+1)%<a class="code" href="_m_p_x___r5_8h.html#aa23c661441688350614bd6a350d2b6ff">size</a>;
<a name="l00175"></a>00175                                 <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ad06a8146a22a605c0f463b212774cc92">ringbufcount</a>--;
<a name="l00176"></a>00176                                 
<a name="l00177"></a>00177                         } <span class="comment">//end while </span>
<a name="l00178"></a>00178           
<a name="l00179"></a>00179                         enable(); <span class="comment">//enable interrupts </span>
<a name="l00180"></a>00180         
<a name="l00181"></a>00181                 <span class="comment">//the requestor buffer is not yet full     </span>
<a name="l00182"></a>00182                 <span class="keywordflow">if</span>(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aff338e9d555a8f740e997650a862b523">indone</a> &lt; *(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ab46085fdbca4da85dfbbbf7baafc4612">incount</a>)) 
<a name="l00183"></a>00183                         <span class="keywordflow">return</span> 0;  
<a name="l00184"></a>00184                 <span class="keywordflow">if</span>(*(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a031f8856932341c5b5bf979b4da0d5df">inbuff</a>-1) == <span class="charliteral">&#39;\r&#39;</span>)
<a name="l00185"></a>00185                         *(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a031f8856932341c5b5bf979b4da0d5df">inbuff</a>-1) = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00186"></a>00186                 <span class="keywordflow">else</span>
<a name="l00187"></a>00187                         *<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a031f8856932341c5b5bf979b4da0d5df">inbuff</a> = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00188"></a>00188                 
<a name="l00189"></a>00189                 <span class="comment">//Reset the DCB status to idle, set the event flag, and</span>
<a name="l00190"></a>00190                 <span class="comment">//return the actual count to the requestor&#39;s variable. </span>
<a name="l00191"></a>00191                 <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aaaefcdae0117d89bef5340a1e3f432e1">status</a> = IDLE; <span class="comment">//status back to IDLE </span>
<a name="l00192"></a>00192                 *<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aa14e67b7bd4e2bc5751268f0be91983f">flag_ptr</a> = SET; <span class="comment">//the event is over </span>
<a name="l00193"></a>00193                 *<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ab46085fdbca4da85dfbbbf7baafc4612">incount</a> = <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aff338e9d555a8f740e997650a862b523">indone</a>; 
<a name="l00194"></a>00194          <span class="keywordflow">return</span> 0;
<a name="l00195"></a>00195         }
<a name="l00196"></a>00196 
<a name="l00197"></a><a class="code" href="_m_p_x___r5_8h.html#ad6bffe8f80cce75f1162d0b4c8e98a9c">00197</a>         <span class="keywordtype">int</span> <a class="code" href="_m_p_x___r5_8_c.html#af03ea2dd941f2ecc4035da028d1f41b5">com_write</a> (<span class="keywordtype">char</span> *buf_p,<span class="keywordtype">int</span> *count_p){
<a name="l00198"></a>00198                 <span class="keywordtype">int</span> mask; 
<a name="l00199"></a>00199                 <span class="comment">//Ensure that the input parameters are valid. </span>
<a name="l00200"></a>00200                 <span class="keywordflow">if</span>(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ac2d4a1d39c1a5a858d88f2482d6900c8">flag</a> != <a class="code" href="_m_p_x___r5_8h.html#a1354b70ac6803a06beebe84f61b5f95b">OPEN</a>) <span class="comment">//check if device is open </span>
<a name="l00201"></a>00201                         <span class="keywordflow">return</span> WRITE_PORT_NOT_OPEN; 
<a name="l00202"></a>00202                 <span class="keywordflow">if</span>(<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aaaefcdae0117d89bef5340a1e3f432e1">status</a> != <a class="code" href="_m_p_x___r5_8h.html#a9c21a7caee326d7803b94ae1952b27ca">IDLE</a>) <span class="comment">//check if device is idle </span>
<a name="l00203"></a>00203                         <span class="keywordflow">return</span> WRITE_DEV_BUSY; 
<a name="l00204"></a>00204                 <span class="keywordflow">if</span>(buf_p == NULL) <span class="comment">//check if buffer is empty </span>
<a name="l00205"></a>00205                         <span class="keywordflow">return</span> WRITE_INV_BUFF_ADD; 
<a name="l00206"></a>00206                 <span class="keywordflow">if</span>(count_p == NULL) <span class="comment">//check pointer is null </span>
<a name="l00207"></a>00207                         <span class="keywordflow">return</span> WRITE_INV_COUNT; 
<a name="l00208"></a>00208                 
<a name="l00209"></a>00209                 <span class="comment">//Install the buffer pointer and counters in the DCB, and set the current status to writing. </span>
<a name="l00210"></a>00210                 <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a32acea82810b51d93df2d3ced6cdffb7">outbuff</a> = buf_p; 
<a name="l00211"></a>00211                 <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ae597c46dee282a47174100b12525b424">outcount</a> = count_p; 
<a name="l00212"></a>00212                 <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ab7c43127bcb340d678131fd04c37ba05">outdone</a> = 0; 
<a name="l00213"></a>00213                 <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aaaefcdae0117d89bef5340a1e3f432e1">status</a> = WRITE;
<a name="l00214"></a>00214                 <span class="comment">//Clear the caller&#39;s event flag. </span>
<a name="l00215"></a>00215                 *<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#aa14e67b7bd4e2bc5751268f0be91983f">flag_ptr</a> = FLAG_CLEAR; 
<a name="l00216"></a>00216                 
<a name="l00217"></a>00217                 <span class="comment">//Get the first character from the requestor&#39;s buffer and store it in the output register. </span>
<a name="l00218"></a>00218                 outportb(<a class="code" href="_m_p_x___r5_8h.html#a79bcfb6bde984f42d1124b068a509af7">BASE</a>, *<a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a32acea82810b51d93df2d3ced6cdffb7">outbuff</a>); 
<a name="l00219"></a>00219                 <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#a32acea82810b51d93df2d3ced6cdffb7">outbuff</a>++; 
<a name="l00220"></a>00220                 <a class="code" href="_m_p_x___r5_8h.html#acf6724d515070007ff4ac39c32640311">dcbPtr</a>.<a class="code" href="structdevice.html#ab7c43127bcb340d678131fd04c37ba05">outdone</a>++; 
<a name="l00221"></a>00221          
<a name="l00222"></a>00222                  
<a name="l00223"></a>00223                  <span class="comment">//Enable write interrupts by setting bit 1 of the Interrupt Enable register. </span>
<a name="l00224"></a>00224                  <span class="comment">//This must be done by setting the register to the logical or of its previous </span>
<a name="l00225"></a>00225                  <span class="comment">//contents and 0x02. </span>
<a name="l00226"></a>00226 
<a name="l00227"></a>00227                 mask = inportb(<a class="code" href="_m_p_x___r5_8h.html#a8dc8a6ba32861f0a3cbd89fa1ec0d216">INT_EN</a>); 
<a name="l00228"></a>00228                 mask = mask | 0x02; 
<a name="l00229"></a>00229                 outportb(<a class="code" href="_m_p_x___r5_8h.html#a8dc8a6ba32861f0a3cbd89fa1ec0d216">INT_EN</a>,mask); 
<a name="l00230"></a>00230     
<a name="l00231"></a>00231         <span class="keywordflow">return</span> 0; 
<a name="l00232"></a>00232         }
<a name="l00233"></a>00233 
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated on Fri Dec 10 2010 01:08:38 for PMOS Programmers Manual by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
